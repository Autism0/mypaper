
\rhead{\xiaowuhao\sectionindex\quad代码修改影响分析与修改周期预测系统}
\section{代码修改影响分析与修改周期预测系统}
\par{本章结合第二章与第三章的研究内容，通过本文提出的修改影响分析辅助方法和修改完成预测方法构建我们的代码修改影响分析与周期预测系统。系统的实现采用MVC(Model-View-Controller)模式，实现平台为Java，采用Spring Boot框架进行系统构建，前端使用Thymeleaf引擎，后台数据库为MongoDB数据库。其中，该系统主要分为三大模块：(1)代码修改影响分析模块；(2)代码修改周期预测模块；(3)基础服务模块。
系统功能模块图如图所示。}
\begin{figure}[h]
\centering
\includegraphics[width=5.5in]{myfigure/system.pdf}
\caption{系统功能结构图}
\label{fig:system}
\end{figure}
\subsection{系统需求分析}
\par{本系统结合了第二章与第三章提出的方法，本系统主要目标用户为程序开发人员。图\ref{UML}为系统用例分析图， 主要有数据收集与预处理，模型训练以结果展示三大核心需求。下面对对系统用例进行详细介绍。}
\begin{figure}[h]
\centering
\includegraphics[width=5.5in]{myfigure/uml.pdf}
\caption{代码修改影响分析与修改周期预测系统用例分析图}
\label{UML}
\end{figure}
\par{\textbf{1）数据收集与预处理}}
\par{本文提出的两种方法都是基于历史代码修改信息实现，因此，我们需要提前收集一些开源项目的历史提交信息及历史审核信息。另外，需要对这些数据进行一些预处理操作，去除历史数据中的噪声数据。该用例还包括的功能有：历史提交中修改信息的提取、修改代码之间结构耦合信息提取以及提交中用于周期预测的可判别特征提取。最后将相关数据存储于本地仓库中。}
\par{\textbf{2）	模型训练}}
\par{在修改影响分析的详细提交检索基于词向量模型实现，而代码修改周期预测方法通过机器学习模型实现，除了可判别特征的提取外，模型训练效果直接影响预测结果。在系统中，我们提供多种机器学习算法，以及相应的可设置参数。}
\par{\textbf{3）	结果展示}}
\par{本章系统主要实现代码修改影响分析功能以及代码修改周期预测功能。在修改影响分析功能中，开发人员在前端上传相关修改代码、修改目标信息以及选定初始影响分析方法，后台根据初始影响分析方法得到初始影响集，再通过影响分析辅助方法对初始影响集进行优化，得到最终影响集并返回前端显示。在代码修改周期预测中，开发人员上传相关修改代码以及审核信息，后台关联其相关项目，根据项目中的代码修改和审核信息训练模型，再对其上传内容进行预测，并把结果返回前端显示。}
\subsection{代码修改影响分析模块实现}
\par{代码修改影响分析模块在历史提交库中检索与目标修改任务相似的提交，利用历史提交中关键类的修改模式，对当前修改类进行影响集的推荐。该模块包含一下几个功能：（1）关键类识别功能；（2）代码修改提取功能；（3）相似提交检索功能；（4）类间耦合关系提取功能；（5）影响集推荐功能。}
\begin{table}[h]
\caption{修改影响分析主要类及对应功能}
\begin{center}
\begin{scriptsize}
\setlength{\tabcolsep}{7mm}{
\begin{tabular}{ll}
\toprule 
\textbf{类名称}                    & \textbf{类功能描述}                \\
\midrule 
ClassChange            & 提取提交两个版本中同个类的修改信息    \\
VersionChange          & 提取提交两个版本的修改信息        \\
Word2VecModel          & 封装词向量模型              \\
CoreClassModel         & 封装关键类识别模型            \\
InitImpactSetGenerator & 封装多种传统影响分析方法，生成初始影响集 \\
CouplingRelations      & 提取类间结构耦合关系           \\
ImpactSetOptimizer     & 初始影响集排序的调整，返回最终影响集\\
\bottomrule
\end{tabular}}
\label{RQ2 result}
\end{scriptsize}
\end{center}
\end{table}
\par{图\ref{method1}为本功能模块的运行流程图。用户上传涉及修改的代码和修改目标后，系统通过文本预处理对两份数据进行处理，得到与历史提交库中相同的文本形式；通过词向量模型，对比用户输入数据与提交库每个提交中关键类的相似度，得到最相似的提交列表；用户选择初始影响分析方法，得到初始影响集，系统计算相似提交中关键类与非关键类的耦合关系以及修改类与初始影响集中类的耦合关系，再基于两部分耦合关系中相似的部分，对初始影响集进行优化排序，得到最终影响集。下面，我们简要阐述子功能模块的实现。}
\begin{figure}[h]
\centering
\includegraphics[width=5.5in]{myfigure/method1.pdf}
\caption{代码修改影响分析流程图}
\label{method1}
\end{figure}
\subsubsection{关键类识别功能}
\par{在本文影响分析方法中，关键类识别功能作为我们系统的核心模块之一。关键类识别功能是为了识别提交中核心修改的类。在相似提交检索及基于结构耦合相似性的影响集调整等两个步骤中，我们都是将提交中的关键类作为修改类的等价类。相似提交检索中，衡量指标是用户上传的代码修改片段与关键类的代码修改片段之间的相似度以及修改目标与注释文本的相似度。在对初始影响集的调整中，我们利用关键类的修改模式，对影响分析结果进行优化重排序。}
\par{由于关键类判别模型已离线训练，系统中可以直接使用关键类识别模型。同时，由于提交数据库庞大，关键类的识别可离线完成。在用户使用阶段，可直接读取每个提交中的关键类。}
\subsubsection{代码修改提取功能}
\par{代码修改提取功能作为相似提交检索功能的基础模块，其主要功能是对用户上传的文件进行修改片段提取及不同版本代码对比。修改代码片段包括了变化的类，变化的方法以及变化的语句等。同时，若影响分析中引入修改后的代码片段，代码修改提取功能中还实现了新旧代码的对比。}
\subsubsection{相似提交检索功能}
\par{相似提交检索功能的核心利用提交库中的代码数据以及提交注释文本数据训练词向量模型，再基于词向量模型计算用户上传数据与提交库中提交的相似度，得到相似提交列表。在系统中，用户可根据需要，选择根据提交库训练词向量模型，也可以上传词向量模型。用户可以选择需要的相似提交数量，另外，在相似提交列表中，系统根据相似度从大到低展示相似提交，展示的数据包括了，注释文本相似度，修改前代码相似度，修改后代码相似度（若影响分析中引入修改后代码片段）以及综合相似度。另外，用户可以点击相似提交查看该提交的信息，包括注释信息，包含类的数量。} 
\subsubsection{类间耦合关系提取功能}
\par{本文的影响分析中初始影响集的优化重排序的基础是结构耦合关系的相似性。类间耦合关系的提取主要分为两部分，一是修改类与初始影响集中各个类的结构耦合关系，另一部分是相似提交中关键类与非关键类的耦合关系。通过该功能模块，用户可以选择查看不同类间的结构耦合关系。}
\subsubsection{影响集推荐功能}
\par{影响集推荐功能模块用于展示影响分析结果。} 
\subsection{代码修改周期预测模块实现}
\par{代码修改周期预测模块包括以下几个功能：（1）数据收集功能；（2）可判别特征提取功能；（3）机器学习模型训练功能；（4）修改周期预测功能。该模块主要实现对用户上传的数据，进行可判别特征的提取；提供机器学习模型的训练，以及修改周期预测等功能，表\ref{mainclass2}为该模块主要类及对应功能。}
\begin{table}[h]
\caption{修改影响分析主要类及对应功能}
\begin{center}
\begin{scriptsize}
\setlength{\tabcolsep}{7mm}{
\begin{tabular}{ll}
\toprule 
\textbf{类名称}                   & \textbf{类功能描述}                \\
\midrule
DataSet               & 封装已有代码修改及审核数据集，可替换成用户上传数据集    \\
ReviewMetaFeatures    & 提取代码审核元特征        \\
CodeCouplingFeatures  & 提取代码耦合特征              \\
CodeModifyingFeatures & 提取代码修改特征            \\
FeatureProcessing     & 封装一些特征工程的处理方法                     \\
Model                 & 封装多种机器学习模型\\
\bottomrule
\end{tabular}}
\label{mainclass2}
\end{scriptsize}
\end{center}
\end{table}
\par{图4-5为本功能模块的运行流程图。用户上传代码修改数据及审核信息（另外，用户可上传项目历史修改数据集，也可以接入项目的代码审核平台，若用户未上传该部分数据，则系统默认使用已有数据集训练预测模型）。系统对用户上传数据进行一些文本预处理，然后提取代码审核元特征、代码耦合特征、代码修改特征。在预测模型训练部分，系统提供了多种机器学习模型供用户选择；同时，用户也可以直接使用已训练好的模型，对上传数据进行修改周期预测。下面我们对这几个功能作简要的说明。}
\begin{figure}[h]
\centering
\includegraphics[width=4.2in]{myfigure/method21.pdf}
\caption{代码修改周期预测流程图}
\label{method1}
\end{figure}
\subsubsection{数据收集功能}
\par{数据收集模块主要用于收集用户的上传的代码修改数据。系统中已有两个开源项目Eclipse和OpenDaylight的数据集用于训练机器学习模型，同时，用户也可以上传本项目的历史修改数据集。另外，如果修改涉及项目的使用了Gerrit审核平台，用户可以通过提供Gerrit项目地址的方式，提供项目代码修改的历史数据信息。}
\subsubsection{可判别特征提取功能}
\par{可判别特征提取是系统实现周期预测的核心功能，其主要目标是从用户上传的数据中提取本文3.2节中描述的40维特征，另外如果用户上传了自己的数据集，该模块还需对数据集中的代码和审核数据进行处理。在该模块中，用户可以查看审核元特征、代码耦合特征和代码修改特征下各维特征的详细数据。}
\subsubsection{机器学习模型训练功能}
\par{机器学习模型训练模块中实现了多种机器学习模型，其中默认使用通过已有数据训练的\emph{XGBoost}模型。另外，用户也可选择训练其他常用的机器学习模型，如\emph{LR}、\emph{SVM}、\emph{RF}和\emph{ANN}等。在数据集使用方面，用户可以选择已有数据，或者自行上传数据集。}
\subsubsection{修改周期预测功能}
\par{修改周期预测功能主要是向用户展示模型预测结果。}